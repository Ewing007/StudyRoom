<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ewing.mapper.AnnouncementTableMapper">

    <resultMap id="BaseResultMap" type="com.ewing.domain.entity.AnnouncementTable">
            <id property="id" column="id" jdbcType="BIGINT"/>
            <result property="title" column="title" jdbcType="VARCHAR"/>
            <result property="content" column="content" jdbcType="VARCHAR"/>
            <result property="authorId" column="author_id" jdbcType="VARCHAR"/>
            <result property="authorName" column="author_name" jdbcType="VARCHAR"/>
            <result property="createdTime" column="created_time" jdbcType="TIMESTAMP"/>
            <result property="status" column="status" jdbcType="CHAR"/>
            <result property="startTime" column="start_time" jdbcType="TIMESTAMP"/>
            <result property="endTime" column="end_time" jdbcType="TIMESTAMP"/>
            <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,title,content,
        author_id,author_name,created_time,
        status,start_time,end_time
    </sql>


    <!-- 查询所有有效公告 -->
    <select id="selectAllAnnouncements" resultMap="BaseResultMap">
        SELECT
            id,
            title,
            content,
            author_id,
            author_name,
            created_time,
            status,
            start_time,
            end_time,
            update_time
        FROM
            announcement_table
        WHERE
            status = '0' AND end_time &gt;= NOW()
    </select>

    <!-- 插入公告 -->
    <insert id="insertAnnouncement" parameterType="com.ewing.domain.entity.AnnouncementTable">
        INSERT INTO announcement_table (title, content, author_id, author_name, created_time, status, start_time, end_time)
        VALUES (#{title}, #{content}, #{authorId}, #{authorName}, NOW(), #{status}, #{startTime}, #{endTime})
    </insert>

    <!-- 根据ID查询公告 -->
    <select id="selectAnnouncementById" resultMap="BaseResultMap" parameterType="long">
        SELECT
            id,
            title,
            content,
            author_id,
            author_name,
            created_time,
            status,
            start_time,
            end_time
        FROM
            announcement_table
        WHERE
            id = #{id}
    </select>

    <!-- 更新公告 -->
    <update id="updateAnnouncement" parameterType="com.ewing.domain.entity.AnnouncementTable">
        UPDATE
            announcement_table
        SET
            title = #{title},
            content = #{content},
            status = #{status},
            start_time = #{startTime},
            end_time = #{endTime},
            update_time = NOW()
        WHERE
            id = #{id}
    </update>

    <!-- 查询已发布且结束时间已到的公告 -->
    <select id="selectActiveAnnouncements" resultMap="BaseResultMap">
        SELECT
        id,
        title,
        content,
        author_id,
        author_name,
        created_time,
        status,
        start_time,
        end_time
        FROM
        announcement_table
        WHERE
        status = '1' AND end_time &lt;= NOW()
    </select>

    <!-- 更新公告状态为已过期 -->
    <update id="updateAnnouncementStatusToExpired" parameterType="long">
        UPDATE
            announcement_table
        SET
            status = '1',
            update_time = NOW()
        WHERE
            id = #{id} AND status != '1'
    </update>

    <!-- 根据用户ID查询公告 -->
    <select id="selectAnnouncementsByUserId" resultMap="BaseResultMap" parameterType="string">
        SELECT
            id,
            title,
            content,
            author_id,
            author_name,
            created_time,
            status,
            start_time,
            end_time
        FROM
            announcement_table
        WHERE
            author_id = #{userId} AND status = '1'
        ORDER BY
            created_time DESC
    </select>
</mapper>
